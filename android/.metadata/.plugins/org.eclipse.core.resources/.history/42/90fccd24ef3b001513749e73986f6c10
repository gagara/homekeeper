package com.gagara.homekeeper.model;

import static com.gagara.homekeeper.common.Constants.UNDEFINED_DATE;

import java.util.Date;

import android.os.Bundle;
import android.util.SparseArray;

public class NodeModel implements Model {

    private int id = 0;
    private boolean state = true;
    private Date switchTimestamp = UNDEFINED_DATE;
    private boolean forcedMode = false;
    private Date forcedModeTimestamp = UNDEFINED_DATE;
    private SparseArray<SensorModel> sensors = new SparseArray<SensorModel>();

    public NodeModel(int id) {
        this.id = id;
    }

    @Override
    public void saveState(Bundle bundle) {
        saveState(bundle, "");
    }

    @Override
    public void saveState(Bundle bundle, String prefix) {
        bundle.putBoolean(prefix + "node_" + id + "_state", state);
        bundle.putLong(prefix + "node_" + id + "_switchTs", switchTimestamp.getTime());
        bundle.putBoolean(prefix + "node_" + id + "_forcedMode", forcedMode);
        bundle.putLong(prefix + "node_" + id + "_forcedModeTs", forcedModeTimestamp.getTime());
        if (sensors.size() > 0) {
            int[] ids = new int[sensors.size()];
            for (int i = 0; i < sensors.size(); i++) {
                sensors.valueAt(i).saveState(bundle, prefix + "node_" + id + "_sensors_");
                ids[i] = sensors.keyAt(i);
                i++;
            }
            bundle.putIntArray(prefix + "node_" + id + "_sensors_ids", ids);
        }
    }

    @Override
    public void restoreState(Bundle bundle) {
        restoreState(bundle, "");
    }

    @Override
    public void restoreState(Bundle bundle, String prefix) {
        state = bundle.getBoolean(prefix + "node_" + id + "_state", state);
        switchTimestamp = new Date(bundle.getLong(prefix + "node_" + id + "_switchTs"));
        forcedMode = bundle.getBoolean(prefix + "node_" + id + "_forcedMode", forcedMode);
        forcedModeTimestamp = new Date(bundle.getLong(prefix + "node_" + id + "_forcedModeTs"));
        int[] ids = bundle.getIntArray(prefix + "node_" + id + "_sensors_ids");
        if (ids != null) {
            sensors.clear();
            for (int i = 0; i < ids.length; i++) {
                SensorModel sm = new SensorModel(ids[i]);
                sm.restoreState(bundle, prefix + "node_" + id + "_sensors_");
                sensors.put(ids[i], sm);
            }
        }
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public boolean getState() {
        return state;
    }

    public void setState(boolean state) {
        this.state = state;
    }

    public Date getSwitchTimestamp() {
        return switchTimestamp;
    }

    public void setSwitchTimestamp(Date switchTimestamp) {
        this.switchTimestamp = switchTimestamp;
    }

    public boolean isForcedMode() {
        return forcedMode;
    }

    public void setForcedMode(boolean forcedMode) {
        this.forcedMode = forcedMode;
    }

    public Date getForcedModeTimestamp() {
        return forcedModeTimestamp;
    }

    public void setForcedModeTimestamp(Date forcedModeTimestamp) {
        this.forcedModeTimestamp = forcedModeTimestamp;
    }

    public SparseArray<SensorModel> getSensors() {
        return sensors;
    }

    public void setSensors(SparseArray<SensorModel> sensors) {
        this.sensors = sensors;
    }

    public void addSensor(SensorModel sensor) {
        this.sensors.put(sensor.getId(), sensor);
    }
}

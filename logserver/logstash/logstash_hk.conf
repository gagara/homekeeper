input {
    http {
        host => "0.0.0.0"
        port => 8085
        response_headers => {"Content-Length" => "0"}
    }
}

filter {
    json {
        source => "message"
    }
    if ([m] == "csr") {
        if ([n]) {
            mutate { add_field => { "csr_type" => "node" "csr_state" => "actual" "id" => "%{[n][id]}" "ns" => "%{[n][ns]}" "n_id_" => "_%{[n][id]}" "n_ns_" => "_%{[n][ns]}" } }
        }
        if ([s]) {
            mutate { add_field => { "csr_type" => "sensor" "csr_state" => "actual" "s_id_" => "_%{[s][id]}" } }
            if ([s_id_] == "_60") {
                mutate { add_field => { "sensor_type" => "state" } }
            } else {
                mutate { add_field => { "sensor_type" => "value" } }
            }
            if ([s][ts]) {
                mutate { add_field => { "ts" => "%{[s][ts]}" "s_v" => "%{[s][v]}" } }
                elasticsearch {
                    hosts => ["elasticsearch:9200"]
                    index => "logstash_hk-*"
                    query => "m:csr AND s.id:%{[s][id]}"
                    fields => { "ts" => "prev_ts_" "s_v" => "prev_s_v_" }
                }
                if ([s][ts] == [prev_ts_]) {
                    mutate { replace => { "csr_state" => "outdated" } }
                }
                if ([sensor_type] == "state" and [s][v] != [prev_s_v_]) {
                    elasticsearch {
                        hosts => ["elasticsearch:9200"]
                        index => "logstash_hk-*"
                        query => "m:csr AND s.id:%{[s][id]} AND s.v:%{[s][v]}"
                        fields => { "@timestamp" => "prev_timestamp" }
                    }
                    date {
                        match => ["[prev_timestamp]", "ISO8601"]
                        target => "[prev_timestamp]"
                    }
                    ruby {
                        code => "event['period'] = (event['@timestamp'] - event['prev_timestamp']) * 1000 rescue nil"
                    }
                }
            }
        }
    }

    if ([m] == "nsc") {
        mutate { add_field => { "n_id_" => "_%{id}" "n_ns_" => "_%{ns}"} }
        if ([n_ns_] == "_0") {
            elasticsearch {
                hosts => ["elasticsearch:9200"] 
                index => "logstash_hk-*"
                query => "m:nsc AND id:%{[id]} AND ns:1"
                fields => { "@timestamp" => "prev_timestamp" }
            }
        }
        if ([n_ns_] == "_1") {
            elasticsearch {
                hosts => ["elasticsearch:9200"]
                index => "logstash_hk-*"
                query => "m:nsc AND id:%{[id]} AND ns:0"
                fields => { "@timestamp" => "prev_timestamp" }
            }
        }
        date {
            match => ["[prev_timestamp]", "ISO8601"]
            target => "[prev_timestamp]"
        }
        ruby {
            code => "event['period'] = (event['@timestamp'] - event['prev_timestamp']) * 1000 rescue nil"
        }
    }

    if ([n_ns_] == "_0") {
        mutate { add_field => { "state" => "false" "state_str" => "OFF" } }
    }
    if ([n_ns_] == "_1") {
        mutate { add_field => { "state" => "true" "state_str" => "ON" } }
    }

    if ([n_id_] == "_22") {
        mutate { add_field => { "name" => "Supply" } }
    }
    if ([n_id_] == "_24") {
        mutate { add_field => { "name" => "Heating" } }
    }
    if ([n_id_] == "_26") {
        mutate { add_field => { "name" => "Floor" } }
    }
    if ([n_id_] == "_28") {
        mutate { add_field => { "name" => "Hot water" } }
    }
    if ([n_id_] == "_30") {
        mutate { add_field => { "name" => "Circulation" } }
    }
    if ([n_id_] == "_32") {
        mutate { add_field => { "name" => "Boiler" } }
    }
    if ([n_id_] == "_34") {
        mutate { add_field => { "name" => "Standby heater" } }
    }

    if ([s_id_] == "_54") {
        mutate { add_field => { "name" => "Supply" } }
    }
    if ([s_id_] == "_55") {
        mutate { add_field => { "name" => "Reverse" } }
    }
    if ([s_id_] == "_56") {
        mutate { add_field => { "name" => "Tank" } }
    }
    if ([s_id_] == "_57") {
        mutate { add_field => { "name" => "Boiler" } }
    }
    if ([s_id_] == "_58") {
        mutate { add_field => { "name" => "Mix" } }
    }
    if ([s_id_] == "_59") {
        mutate { add_field => { "name" => "Standby heater" } }
    }
    if ([s_id_] == "_60") {
        mutate { add_field => { "name" => "Boiler Power" } }
    }
    if ([s_id_] == "_74") {
        mutate { add_field => { "name" => "Room Temperature" } }
    }
    if ([s_id_] == "_75") {
        mutate { add_field => { "name" => "Room Humidity" } }
    }

    mutate {
        remove_field => [ "n_id_", "s_id_", "n_ns_", "prev_ts_", "prev_s_v_" ]
    }
}

output {
    elasticsearch {
        hosts => "elasticsearch:9200"
        index => "logstash_hk-%{+YYYY.MM.dd}"
        template => "/opt/logstash/config/template_hk.json"
        template_overwrite => "true"
    }
}
